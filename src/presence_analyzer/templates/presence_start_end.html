<%! 
    active = 'presence start end' 
%>
<%inherit file="template_base.html"/>
<%block name="content" >
    <head>
        <script type="text/javascript">
            google.load("visualization", "1", {packages:["corechart", "timeline"], 'language': 'pl'});
        </script>
        <script src="${url_for('static', filename='js/parseInterval.js')}">
        </script>
        <script type="text/javascript"> 

            (function($) {
                $(document).ready(function(){
                    var loading = $('#loading'), avatars = {};
                    $.getJSON("${url_for('users_xml_view')}", function(result) {
                        var dropdown = $("#user_id");
                        users = result;
                        $.each(result, function(item) {
                            avatars[this[0]] = this[1].image;
                            dropdown.append($("<option />").val(this[0]).text(this[1].name));
                        });
                        dropdown.show();
                        loading.hide();
                    });
                    $('#user_id').change(function(){
                        var selected_user = $("#user_id").val();
                        var chart_div = $('#chart_div');
                        var avatar = $('#image');
                        if(selected_user) {
                            loading.show();
                            chart_div.hide();   
                            avatar.hide();          
                            avatar.attr('src', avatars[selected_user]);
                            $.getJSON("${url_for('presence_start_end_view', user_id = 0)}"+selected_user, function(result){
                                $.each(result, function(index, value) {
                                    index[0] = parseInterval(index[1]);
                                    value[1] = parseInterval(value[1]);
                                    value[2] = parseInterval(value[2]);
                                });
                                var data = new google.visualization.DataTable();
                                data.addColumn('string', 'Weekday');
                                data.addColumn({ type: 'datetime', id: 'Start' });
                                data.addColumn({ type: 'datetime', id: 'End' });
                                data.addRows(result);
                                var options = {
                                    hAxis: {title: 'Weekday'}
                                };
                                var formatter = new google.visualization.DateFormat({pattern: 'HH:mm:ss'});
                                formatter.format(data, 1);
                                formatter.format(data, 2);
                                chart_div.show();
                                avatar.show();
                                loading.hide();
                                var chart = new google.visualization.Timeline(chart_div[0]);
                                chart.draw(data, options);
                            });
                        }
                    });
                });
            })(jQuery);
        </script>
    </head>
</%block>
<%block name="title">
    Presence start end
</%block>
